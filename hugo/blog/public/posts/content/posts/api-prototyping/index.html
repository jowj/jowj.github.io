<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>rest api prototyping | josiah&#39;s blog</title>
<link rel="stylesheet" href="/css/my-dark.css">

</head>
<body>
  <header>
    <h1>josiah&#39;s blog</h1>
<nav>
    <a href="">home</a>
    <a href="posts/">posts</a>
    <a href="personal/">diary</a>
    <a href="projects/">projects</a>
    <a href="resume.pdf">resume</a>
    <a href="lore/">lore</a>
</nav>


  </header>
  <main>
    
  <h1>rest api prototyping</h1>

  
  
  <time datetime="0001-01-01T00:00:00&#43;00:00">January 1, 1</time>

  <h2 id="the-problem">the problem</h2>
<p>lately i&rsquo;ve been working on a lot of web API glue projects. these are usually simple things like &ldquo;service1 needs to send messages to service2 in a particular format, with a particular set of priviledges.&rdquo; Sometimes its more complicated, but that&rsquo;s usually what it breaks down to.</p>
<p>at first I was writing python code the whole time, exploring the API through python (ugh) and kept getting frustrated; it felt like I wasn&rsquo;t able to go as fast as I would like, I kept making silly mistakes that I wouldn&rsquo;t catch until much later, etc. To fix this, i&rsquo;ve moved to prototyping in <a href="https://github.com/pashky/restclient.el">restclient.el</a> - this is a featureful rest client that you interact with through plain text (i.e., you can version control it!) within emacs.</p>
<p>this has worked great for a lot of things, but falls short when you have to generate an auth token programmatically (instead of using a static key) for each request. this problem is solvable using: a different kind of glue lol. i use python to create the auth token, org-babel to register the result and then pass it to `restclient` which will continue to be my prototyping tool of choice. this write up will go over how i stitch each part together; i&rsquo;ll use Cylance as an example service for api requests.</p>
<h2 id="authentication-and-authorization-in-cylance">Authentication and Authorization in Cylance</h2>
<p>Cylance relies on something called JWT (JSON Web Token). There&rsquo;s an RFC for this here: <a href="https://tools.ietf.org/html/rfc7519">https://tools.ietf.org/html/rfc7519</a>. This is not possible to generate within `restclient`, so we do it in python.</p>
<p>To generate the JWT, in Cylance&rsquo;s case, we care about:</p>
<p><code>TID_VAL</code>, which is the tenant ID. You can find this by logging into the console &gt; settings &gt; integrations.
<code>APP_ID</code> and <code>APP_SECRET</code>, which is under the same place, but you&rsquo;ll have to expand the custom application.</p>
<p>We&rsquo;ll add a <code>#+name:</code> argument to the top of the <code>org-mode</code> src block so that the output from the block can be registered for later use.</p>
<h3 id="python-code">python code</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> uuid
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> json
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> jwt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pdb
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime, timedelta
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># initial auth test setup</span>
</span></span><span style="display:flex;"><span>JTI_VAL <span style="color:#f92672">=</span> str(uuid<span style="color:#f92672">.</span>uuid4())
</span></span><span style="display:flex;"><span>TID_VAL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>     <span style="color:#75715e"># The tenant&#39;s unique identifier.</span>
</span></span><span style="display:flex;"><span>APP_ID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>      <span style="color:#75715e"># The application&#39;s unique identifier.</span>
</span></span><span style="display:flex;"><span>APP_SECRET <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>  <span style="color:#75715e"># application&#39;s secret to sign the auth token with.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 30 minutes from now</span>
</span></span><span style="display:flex;"><span>TIMEOUT <span style="color:#f92672">=</span> <span style="color:#ae81ff">1800</span>
</span></span><span style="display:flex;"><span>NOW <span style="color:#f92672">=</span> datetime<span style="color:#f92672">.</span>utcnow()
</span></span><span style="display:flex;"><span>TIMEOUT_DATETIME <span style="color:#f92672">=</span> NOW <span style="color:#f92672">+</span> timedelta(seconds<span style="color:#f92672">=</span>TIMEOUT)
</span></span><span style="display:flex;"><span>EPOCH_TIME <span style="color:#f92672">=</span> int((NOW <span style="color:#f92672">-</span> datetime(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>total_seconds())
</span></span><span style="display:flex;"><span>EPOCH_TIMEOUT <span style="color:#f92672">=</span> int((TIMEOUT_DATETIME <span style="color:#f92672">-</span> datetime(<span style="color:#ae81ff">1970</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))<span style="color:#f92672">.</span>total_seconds())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>AUTH_URL <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://protectapi.cylance.com/auth/v2/token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>CLAIMS <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;exp&#34;</span>: EPOCH_TIMEOUT,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;iat&#34;</span>: EPOCH_TIME,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;iss&#34;</span>: <span style="color:#e6db74">&#34;http://cylance.com&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;sub&#34;</span>: APP_ID,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;tid&#34;</span>: TID_VAL,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;jti&#34;</span>: JTI_VAL
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ENCODED <span style="color:#f92672">=</span> jwt<span style="color:#f92672">.</span>encode(CLAIMS, APP_SECRET, algorithm<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;HS256&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># lol you have to decode from a bytes object to a string because</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># bytes aren&#39;t fucking json serializable</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># you never seem to need to re-encode them? python is so fucking weird.</span>
</span></span><span style="display:flex;"><span>ENCODED <span style="color:#f92672">=</span> ENCODED<span style="color:#f92672">.</span>decode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PAYLOAD <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;auth_token&#34;</span>: ENCODED}
</span></span><span style="display:flex;"><span>HEADERS <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Content-Type&#34;</span>: <span style="color:#e6db74">&#34;application/json; charset=utf-8&#34;</span>}
</span></span><span style="display:flex;"><span>RESP <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(AUTH_URL, headers<span style="color:#f92672">=</span>HEADERS, data<span style="color:#f92672">=</span>json<span style="color:#f92672">.</span>dumps(PAYLOAD))
</span></span><span style="display:flex;"><span>print(json<span style="color:#f92672">.</span>loads(RESP<span style="color:#f92672">.</span>text)[<span style="color:#e6db74">&#39;access_token&#39;</span>])
</span></span></code></pre></div><p>this will generate a token and attach it to the name space <code>jwt_token</code> as defined previously.</p>
<h3 id="restclient-example">restclient example</h3>
<p>once the previous block has run to generate the json web token  we can pass it on to this restclient block and use it to query Cylance&rsquo;s API through <code>restclient.el</code> going forward! in order to pass the output from the registered name we used before, <code>jwt_token</code>, we add an argument to the <code>BEGIN_SRC</code> header, like <code>:var x=jwt_token</code>. Then, we can set a <code>restclient</code> local variable equal to the <code>org-babel</code> super-variable and use it within the rest of the src block, as seen below:</p>
<pre tabindex="0"><code class="language-restclient" data-lang="restclient"># auth.test
:cylance_jwt_token = :x
GET https://protectapi.cylance.com/users/v2?page=1&amp;page_size=1
Authorization: Bearer :cylance_jwt_token
Content-Type: application/json
User-Agent: Emacs Restclient
</code></pre><p>this will return my user (again, i&rsquo;ve disturbed the output but it is roughly what&rsquo;s returned):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;page_number&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;page_size&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;total_pages&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;total_number_of_items&#34;</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">6</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;page_items&#34;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;tenant_id&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;first_name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;last_name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;email&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;me@thiscompanyyo.isit&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;has_logged_in&#34;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role_type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;role_name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;i am the boss&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;default_zone_role_type&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;default_zone_role_name&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;zones&#34;</span><span style="color:#f92672">:</span> [],
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;date_last_login&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2019-11-22T14:52:13&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;date_email_confirmed&#34;</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;date_created&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2019-05-17T17:16:52&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;date_modified&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;2019-05-17T17:16:52&#34;</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// GET https://protectapi.cylance.com/users/v2?page=1&amp;page_size=1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// HTTP/1.1 200 OK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Content-Encoding: gzip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Content-Type: application/json; charset=utf-8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Date: Fri, 22 Nov 2019 16:24:13 GMT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Server: openresty
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Content-Length: 339
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Connection: keep-alive
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Request duration: 0.305690s
</span></span></span></code></pre></div><h2 id="troubleshooting-python-and-org-babel">Troubleshooting python and org-babel</h2>
<p>I had huge issues with python virtual environemtns and org-babel while initially setting up this environment. i once had an issue with emacs, I belive in an older version (25 or below i think) where it couldn&rsquo;t find my python binary on macOS. to fix this i manually set it in my <code>init.el</code> file, which worked for a long time.</p>
<p>however, if you start using venvs <strong>within emacs</strong>, tools like <code>pvenv</code> and <code>venv</code> <strong>will not overwrite the global variable set with the new venv specific python binaries</strong> if you&rsquo;ve globally set the py binary location. This killed me. below are some blocks i used to troubleshoot what was going on.</p>
<p>This one is pretty straight forward: do i have a virtual env active, and where is the python binary as seen by the shell:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>echo $VIRTUAL_ENV
</span></span><span style="display:flex;"><span>which python
</span></span></code></pre></div><p>Same deal, only &ldquo;where is the python binary as seen in the python session&rdquo;. in my case, this was showing me the system python binary even when the <strong>shell</strong> was showing me the venv binary.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> sys
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(sys<span style="color:#f92672">.</span>path))
</span></span></code></pre></div><p>this block just proved that i could in fact import the right modules that were only in the venv.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> jwt
</span></span></code></pre></div>
  


  </main>
  <footer>
    <p>copyright 2024. i love you on every page.</p>

  </footer>
</body>
</html>
